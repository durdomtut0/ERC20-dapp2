<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My dapp</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">

    <script
        src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"
        type="application/javascript"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js" integrity="sha384-mQ93GR66B00ZXjt0YO5KlohRA5SY2XofN4zfuZxLkoj1gXtW8ANNCe9d5Y3eG5eD" crossorigin="anonymous"></script>    
    <link rel="stylesheet" href="style.css">
    
</head>

<body onload="connectWallet()">
      

    <nav class="navbar bg-body-tertiary">
        <div class="container-fluid justify-content-between" >
          <a class="navbar-brand" href="">
            <img src="https://247codecamp.com/wp-content/uploads/2022/11/No-website-247-code-camp-logo3-13.png" alt="Logo" width="104" height="33" class="d-inline-block align-text-start">
            
          </a>
          <a class="navbar-brand">
                Wallet address:  
                <button class="btn btn-outline-primary" onclick="connectWallet()" id = "walletStatus" > Connect Metamask</button>  
                
          </a>
          
        </div>
    </nav>

   
    <div1 class ="div1">
        </br>
        <h1>Library dapp</h1>
        <p>In this dapp you can add books to global library</p>
        <label> Add book </label>
        </br>
        <div class="input-group mb-3">
            <input id = "inputBookName" type="text" class="form-control" placeholder="name" aria-label="Username">
            <span class="input-group-text"> </span>
            <input id = "inputBookAuthor" type="text" class="form-control" placeholder="author" aria-label="Server">
          </div>
        <div class="input-group mb-3">
            <input id = "inputBookYear" type="number" min="0" class="form-control" placeholder="year" aria-label="Username">
            <span class="input-group-text"> </span>
            <input id = "inputBookUrl" type="text" class="form-control" placeholder="url" aria-label="Server">
        </div>  
        
        <button class="btn btn-outline-primary" onclick = "addBook()">Add book</button>
        </br>
        <p>All books in the library:</p>
        <button class="btn btn-outline-primary" onclick = "displayBooks()">Display book</button>


        </br>
        <p>Check your balance</p>
        <button class="btn btn-outline-primary" onclick = "balanceOf()">BalanceOf</button>
        <p>Your balance is: <span id ="balanceOf"></p>
        
    </div1>

    <script>
        
        //Change UI
        //Add books to library
        //Return all books

        //Cntl+Shift+L
        const BookContract = "0xf3280778735C8b7339Cda0C49fa61F49a089885E";
        const BookContractABI = [{"inputs":[{"internalType":"string","name":"title","type":"string"},{"internalType":"string","name":"author","type":"string"},{"internalType":"uint256","name":"datePublished","type":"uint256"},{"internalType":"string","name":"url","type":"string"}],"name":"addBook","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_id","type":"uint256"}],"name":"buyBook","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"books","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"title","type":"string"},{"internalType":"string","name":"author","type":"string"},{"internalType":"uint256","name":"datePublished","type":"uint256"},{"internalType":"string","name":"url","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getAllBooks","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"title","type":"string"},{"internalType":"string","name":"author","type":"string"},{"internalType":"uint256","name":"datePublished","type":"uint256"},{"internalType":"string","name":"url","type":"string"}],"internalType":"struct StructExample.Book[]","name":"_books","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_id","type":"uint256"}],"name":"getBook","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"title","type":"string"},{"internalType":"string","name":"author","type":"string"},{"internalType":"uint256","name":"datePublished","type":"uint256"},{"internalType":"string","name":"url","type":"string"}],"internalType":"struct StructExample.Book","name":"_book","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_id","type":"uint256"}],"name":"getBookDetails","outputs":[{"internalType":"string","name":"title","type":"string"},{"internalType":"string","name":"author","type":"string"},{"internalType":"uint256","name":"datePublished","type":"uint256"},{"internalType":"string","name":"url","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"id","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"myBook","outputs":[{"components":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"string","name":"title","type":"string"},{"internalType":"string","name":"author","type":"string"},{"internalType":"uint256","name":"datePublished","type":"uint256"},{"internalType":"string","name":"url","type":"string"}],"internalType":"struct StructExample.Book","name":"_book","type":"tuple"}],"stateMutability":"view","type":"function"}]
        let Contract;
        let signer;
        
        async function connectWallet(){
            if (!signer){
                //Provider = RPC Node in a blockchain
                const provider = new ethers.providers.Web3Provider(window.ethereum, 97);
                // provider = https://indulgent-newest-leaf.bsc-testnet.discover.quiknode.pro/8a8483b20d028a2b4ca603f1f86a6f1d702a6624/
                await provider.send("eth_requestAccounts", []).then(() => {//request accounts
                    provider.listAccounts().then((accounts) => {//have access to list of accounts
                        signer = provider.getSigner(accounts[0]);//access your connected account
                        Contract = new ethers.Contract(
                            BookContract,
                            BookContractABI,
                            signer
                        );//Create JS object of smart-contract existing on blockchain
                    });
                });
                const walletStatus = document.getElementById("walletStatus");
                walletStatus.innerText = "disconect"

            }
            if (signer){
                //Make it work with real disconnect
                //provider = null;
                //signer = null;
                console.log("signer", signer)
                console.log("disconnect")
                const walletStatus = document.getElementById("walletStatus");
                walletStatus.innerText = "Connect Metamask"
                await displayBooks();
            }
            

        }

        async function addBook(){
            const inputBookName = document.getElementById("inputBookName").value;
            const inputBookAuthor = document.getElementById("inputBookAuthor").value;
            const inputBookYear = document.getElementById("inputBookYear").value;
            const inputBookUrl = document.getElementById("inputBookUrl").value;

            const addBook = Contract.addBook(inputBookName, inputBookAuthor, inputBookYear, inputBookUrl)
            await displayBooks();
        }

        async function displayBooks(){
           const books = await Contract.getAllBooks()
           console.log(books)

           //Look into innerHTML to inject card div into Page

        }
        async function test(){
            alert("testing onload")
        }
        
        async function mint(){
            const number = document.getElementById("mintToken").value
            const store = Contract.mint(number)
            await store;
        }
        async function transfer(){
            const addressToTransfer = document.getElementById("addressToTransfer").value
            let amountToTransfer = document.getElementById("amountToTransfer").value
            //console.log(amountToTransfer);
            const transfer = Contract.transfer(addressToTransfer, amountToTransfer)
            await transfer;
        }
        async function balanceOf(){
            let balance  = BigInt(await Contract.balanceOf(await signer.getAddress()));
            const balanceOf = document.getElementById("balanceOf");
            balanceOf.innerText = balance;

            console.log(balance)
        }
        
        //Improve interface, more user Friendly

    </script>

</body>
</html>